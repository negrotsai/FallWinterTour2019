<!--
author: W3layouts
author URL: http://w3layouts.com
License: Creative Commons Attribution 3.0 Unported
License URL: http://creativecommons.org/licenses/by/3.0/
-->
<!DOCTYPE html>
<html lang="zh-tw">

<head>
  <title>
    2019 秋冬旅遊補助旅宿查詢 | 快速搜尋所有補助旅宿
  </title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
  <!-- for-mobile-apps -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="description" content="2019秋冬旅遊補助配合旅宿查詢，快速搜尋所有補助旅宿，提供距離、預算、人數查詢功能，提供符合您條件的最佳選擇!" />

  <!-- js files-->
  <script id="placeAPIKey" src="API.key"></script>
  <script>
    var key;
    try {
      key = getPlaceAPIKey();
    } catch {
      key = "AIzaSyAOvnmQJzD5JYbuAMILyIzd3CYYcKhjXpk";
    }
    script = document.createElement("script");
    script.setAttribute(
      "src",
      "https://maps.googleapis.com/maps/api/js?key=" +
      key +
      "&libraries=places"
    );
    script.setAttribute("async", "async");
    document.getElementById("placeAPIKey").appendChild(script);
  </script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
  <script defer src="js/get-distance.js"></script>
  <!-- Google Tag Manager -->
  <script>
    (function (w, d, s, l, i) {
      w[l] = w[l] || [];
      w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
      var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != "dataLayer" ? "&l=" + l : "";
      j.async = true;
      j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
      f.parentNode.insertBefore(j, f);
    })(window, document, "script", "dataLayer", "GTM-TPBCWTB");
  </script>
  <!-- End Google Tag Manager -->
  <script data-ad-client="ca-pub-5615497197323260" async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- //js files -->

  <!-- css files -->
  <link href="css/bootstrap.css" rel="stylesheet" type="text/css" />
  <!-- bootstrap css -->
  <link href="css/style.css" rel="stylesheet" type="text/css" />
  <!-- custom css -->
  <link href="css/css_slider.css" type="text/css" rel="stylesheet" media="all" />
  <link href="css/font-awesome.min.css" rel="stylesheet" />
  <!-- fontawesome css -->
  <!-- //css files -->
</head>

<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TPBCWTB" height="0" width="0"
      style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  <!-- header -->
  <header>
    <div class="top-head container">
      <div class="ml-auto text-right right-p">
        <ul>
          <li class="mr-3">
            <span class="fa fa-envelope"></span><a href="mailto:eason010188@gmail.com"> eason010188@gmail.com</a>
          </li>
        </ul>
      </div>
    </div>
    <div class="container">
      <!-- nav -->
      <nav class="py-3 d-lg-flex">
        <div id="logo">
          <h1>
            <a href="index.html"><span class="fa fa-free-code-camp"></span> Trip spot
            </a>
          </h1>
        </div>
        <label for="drop" class="toggle"><span class="fa fa-bars"></span></label>
        <input type="checkbox" id="drop" />
        <ul class="menu ml-auto mt-1">
          <li class="active"><a href="index.html">查詢首頁</a></li>
          <li class="active"><a href="#notice">注意事項</a></li>
          <li class="active">
            <a target="_blank" rel="external noopener noreferrer"
              href="https://admin.taiwan.net.tw/Handlers/FileHandler.ashx?fid=422b8323-c438-4e38-b77c-d8b7bb66482f&type=4&no=1">活動說明</a>
          </li>
          <li class="active">
            <a target="_blank" rel="external noopener noreferrer"
              href="https://fallwintertour.tbroc.gov.tw/customer_apply_page">活動申請</a>
          </li>
          <li class="active">
            <a target="_blank" rel="external noopener noreferrer"
              href="https://fallwintertour.tbroc.gov.tw/hotel">參與業者總覽</a>
          </li>
        </ul>
      </nav>
      <!-- //nav -->
    </div>
  </header>
  <!-- //header -->

  <!-- banner -->
  <div class="banner" id="home">
    <div class="layer">
      <div class="container">
        <div class="col-md-12 banner-text-w3ls">
          <!-- banner slider-->
          <div class="csslider infinity" id="slider1">
            <input type="radio" name="slides" checked="checked" id="slides_1" />
            <ul class="banner_slide_bg">
              <li>
                <div class="container-fluid">
                  <div class="w3ls_banner_txt">
                    <h4>
                      2019秋冬旅遊補助配合旅宿查詢
                    </h4>
                  </div>
                </div>
              </li>
            </ul>
          </div>
          <!-- //banner slider-->
        </div>
        <div class="col-md-12 px-lg-3 px-0">
          <div class="banner-form-w3">
            <div class="padding">
              <form>
                <h5 class="mb-3">想要去哪裡? 快搜尋看看</h5>
                <div class="form-style-w3layout">
                  <div id="LocationSearch">
                    <label for="hotelLocationSearch">輸入想去的地點</label><br />
                    <input placeholder="試看看搜尋 台北火車站" id="hotelLocationSearch" type="text" required="" autocomplete="off"
                      oninput="checkInput()" />
                  </div>
                  <div class="add-search">
                    <label for="hotelAdultSearch">成人人數</label><br />
                    <input placeholder="6" value="2" id="hotelAdultSearch" type="number" min="1" max="6" required=""
                      autocomplete="off" oninput="checkInput()" />
                  </div>
                  <div class="add-search">
                    <label for="hotelPriceSearch">最高預算</label><br />
                    <input placeholder="5000" id="hotelPriceSearch" type="number" min="500" autocomplete="off"
                      oninput="checkInput()" />
                  </div>
                  <button id="SearchBtn" Class="btn" type="button" disabled="disabled"
                    onclick="if(checkInput())gethotelList(globalSelected);">
                    搜尋
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="text-center" id="desktop">
    <ins class="scupioadslot" style="display:inline-block;width:100%;height:90px;max-width:728px;"
      data-sca-pub="lQpUQlpsE3YTFQ==" data-sca-web="5034" data-sca-category="10" data-sca-cid="17570"
      data-sca-slot-type="STA"></ins>
  </div>
  <script async src="https://img.scupio.com/js/ad.js"></script>
  <!-- banner-bottom -->
  <section class="some-content py-3" id="notice">
    <div class="container py-md-3">
      <div class="row about-vv-top">
        <div class="col-lg-6 about-info">
          <h4 class="title-hny mb-md-3">注意事項</h4>
          <ol>
            <li>本站不提供訂房服務，訂房請透過旅宿連絡電話</li>
            <li>列表所示價格為補助前網路價，僅供比價參考</li>
            <li>直接電聯旅宿訂房才可補助，網路訂房不適用</li>
            <li>
              入住前請先進行<a rel="external noopener noreferrer"
                href="https://fallwintertour.tbroc.gov.tw/customer_apply_page">活動申請</a>以確保自身權益
            </li>
            <li>
              其餘事項請見<a rel="external noopener noreferrer"
                href="https://admin.taiwan.net.tw/Handlers/FileHandler.ashx?fid=422b8323-c438-4e38-b77c-d8b7bb66482f&type=4&no=1">活動說明</a>，以取得更多資訊
            </li>
          </ol>
        </div>
        <div class="col-lg-6 text-center testimonials">
          <ins id="mobile" class="scupioadslot" style="display:inline-block;width:336px;height:280px;"
            data-sca-pub="lQpUQlpsE3YTFQ==" data-sca-web="5034" data-sca-category="10" data-sca-cid="17571"
            data-sca-slot-type="STA"></ins>
          <div>Advertisement</div>
        </div>
      </div>
    </div>
  </section>
  <!-- //banner-bottom-->
  <!--list-->
  <main class="hotel-list" id="hotel-list"></main>
  <!--\\list-->
  <!-- //banner -->
  <section class="some-content py-3" id="about">
    <h6 class="title-hny text-center user-info">
      <span>價格僅供比價參考、訂房需直接透過飯店</span>
      <span>資料如有勘誤請藉由右上方Email通知我</span>
    </h6>
  </section>
  <!-- copyright -->
  <div class="copy-right-top">
    <p class="copy-right text-center">
      &copy; 2019 Trip spot | WoWo Workshop. All Rights Reserved | Design by
      <a href="http://w3layouts.com/"> W3layouts </a>
    </p>
  </div>
  <!-- //copyright -->

  <!-- move top -->
  <div class="move-top text-right">
    <a href="#home" class="move-top">
      <span class="fa fa-angle-up" aria-hidden="true"></span>
    </a>
  </div>
  <!-- move top -->
</body>
<script>
  var globalHotelList;
  var globalSelected;
  var globalSelectedList;
  var autocomplete;
  var adults, price;
  window.onload = () => {
    initSearchListener();
    initHandlebarHelper();
    preFetchHotelList();
  };
  function initHandlebarHelper() {
    Handlebars.registerHelper("ImgNameRe", context => {
      result = /[\w]+.(jpg|png)/i.exec(context);
      if (result && result.length > 0) return result[0];
    });
    Handlebars.registerHelper("ImgServer", ID => {
      try {
        getPlaceAPIKey();
        return "../HotelImages";
      } catch {
        return ID % 10 < 6 ? "/HotelImages" : "/HotelImages2";
      }
    });
  }
  function preFetchHotelList() {
    let hotelListVersion = "hotelListV1.1";
    globalHotelList = localStorage.getItem(hotelListVersion);
    if (globalHotelList) {
      globalHotelList = JSON.parse(globalHotelList);
    } else {
      globalHotelList = [];
      $.get(
        "json/hotel.json",
        data => {
          for (towns in data) {
            for (town in data[towns]) {
              data[towns][town].forEach(hotel => {
                globalHotelList.push(hotel);
              });
            }
          }
          localStorage.setItem(
            hotelListVersion,
            JSON.stringify(globalHotelList)
          );
        },
        "json"
      );
    }
  }
  function initSearchListener() {
    let input = document.getElementById("hotelLocationSearch");
    let options = {
      componentRestrictions: { country: "tw" }
    };
    autocomplete = new google.maps.places.Autocomplete(input, options);
    autocomplete.addListener("place_changed", () => {
      place = autocomplete.getPlace(); // 地點資料存進place

      // 確認回來的資料有經緯度
      if (place.geometry) {
        globalSelected = place;
        checkInput();
      } else {
        globalSelected = null;
      }
    });
  }
  async function calculateAllDistance(hotel) {
    if (hotel && hotel.hasOwnProperty("location") && hotel.AgodaID > 0) {
      dist = distance(
        globalSelected.geometry.location.lat(),
        globalSelected.geometry.location.lng(),
        hotel.location.lat,
        hotel.location.lng,
        "K"
      );
      hotel.distance = dist.toFixed(1);
      return hotel;
    }
  }
  async function sortByDistance(arr) {
    arr.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
    return arr;
  }
  async function tryGetRooms(hotel) {
    try {
      await $.get(
        "rooms/" + hotel.AgodaID + ".json",
        rooms => {
          fitRooms = [];
          rooms.forEach(room => {
            if (room.adults >= adults) fitRooms.push(room);
          });
          if (fitRooms.length > 0) {
            fitRooms.sort(
              (a, b) => parseFloat(a.price) - parseFloat(b.price)
            );
            hotel.rooms = fitRooms;
            if (hotel.rooms[0].price < price) globalSelectedList.push(hotel);
          }
        },
        "json"
      );
    } catch (e) {
      console.log(e);
    }
  }
  async function findFitHotels() {
    //get 50 hotels
    let idx = 0;
    let maxDistance = 15;
    let pageSize = 50;
    while (
      globalSelectedList.length < pageSize &&
      idx < globalHotelList.length &&
      globalHotelList[idx].distance <= maxDistance
    ) {
      const promises = globalHotelList
        .slice(idx, idx + pageSize)
        .map(tryGetRooms);
      // wait until all promises are resolved
      await Promise.all(promises);
      idx += pageSize;
    }
  }
  function checkInput() {
    adults = $("#hotelAdultSearch").val();
    price = $("#hotelPriceSearch").val();
    if (!globalSelected) {
      $("#SearchBtn").text("請從列表中選擇地點");
    } else if (!adults) {
      $("#SearchBtn").text("請輸入成人人數");
    } else if (price && price < 500) {
      $("#SearchBtn").text("預算請大於500");
    } else if (adults && (adults > 6 || adults < 1)) {
      $("#SearchBtn").text("成人人數請介於1~6間");
    } else {
      $("#SearchBtn").text("搜尋");
      $("#SearchBtn").removeAttr("disabled");
      return true;
    }
    $("#SearchBtn").attr("disabled", "disabled");
    return false;
  }
  function renderPage(source) {
    template = Handlebars.compile(source);
    context = globalSelectedList;
    html = template(context);
    $(".hotel-list").html(html);
  }
  async function gethotelList() {
    if (checkInput()) {
      if (!price) price = 9999999;
      //搜尋中
      $("#SearchBtn").attr("disabled", "disabled");
      $("#SearchBtn").text("搜尋中...");
      globalSelectedList = [];
      const promises = globalHotelList.map(calculateAllDistance);
      // wait until all promises are resolved
      await Promise.all(promises).then(result => (globalHotelList = result));
      globalHotelList = await sortByDistance(globalHotelList);
      await globalHotelList.filter(el => {
        return el != null;
      });
      await findFitHotels();
      globalSelectedList = await sortByDistance(globalSelectedList);
      if (globalSelectedList.length > 0) {
        await $.get(
          "templates/hotel-list.html",
          source => renderPage(source),
          "html"
        );
      } else {
        await $.get(
          "templates/no-result.html",
          source => renderPage(source),
          "html"
        );
      }
      location.href = "#mobile";
      $("#SearchBtn").text("搜尋");
      $("#SearchBtn").removeAttr("disabled");
    }
  }
    /*
TODO:
1. Add detail btn
2. Add farer range show more button
*/
</script>

</html>